<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Detention Display</title>
  <link rel="icon" type="image/png" href="WTDI.png">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      margin: 0;
      color: #333;
      min-height: 100vh;
    }

    /* Navigation Bar Styles */
    .navbar {
      background: linear-gradient(135deg, #2c5364, #203a43);
      padding: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    .nav-logo {
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-menu {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
      gap: 30px;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 10px 15px;
      border-radius: 8px;
      transition: 0.3s ease;
    }

    .nav-link:hover, .nav-link.active {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }

    /* Main Content */
    .main-content {
      padding: 35px;
    }

    .content-container {
      background: #ffffff;
      padding: 35px;
      border-radius: 15px;
      max-width: 1600px;
      margin-left: -20px;
      margin-right: auto;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      animation: fadeIn 0.7s ease-in-out;
    }

    h2 {
      text-align: center;
      color: #2c5364;
      font-size: 30px;
      font-weight: bold;
      margin-bottom: 25px;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .column-selector {
      position: relative;
      display: inline-block;
    }

    .column-dropdown-btn {
      background: #2c5364;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .column-dropdown-btn:hover {
      background: #203a43;
    }

    .column-dropdown-btn::after {
      content: "‚ñº";
      font-size: 12px;
      transition: 0.3s ease;
    }

    .column-dropdown-btn.active::after {
      transform: rotate(180deg);
    }

    .column-dropdown-content {
      display: none;
      position: absolute;
      background: white;
      min-width: 320px;
      max-width: 400px;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1000;
      padding: 20px;
      top: 100%;
      left: 0;
      margin-top: 5px;
      border: 1px solid #ddd;
    }

    .column-dropdown-content.show {
      display: block;
    }

    .column-dropdown-header {
      margin: 0 0 15px 0;
      color: #2c5364;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      justify-content: center;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      transition: 0.3s ease;
      white-space: nowrap;
    }

    .checkbox-item:hover {
      background: #e9ecef;
      border-color: #2c5364;
    }

    .checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .checkbox-item label {
      cursor: pointer;
      font-size: 14px;
      color: #333;
    }

    .selector-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .select-all-btn, .select-none-btn {
      background: #6c757d;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .select-all-btn:hover {
      background: #5a6268;
    }

    .select-none-btn {
      background: #dc3545;
    }

    .select-none-btn:hover {
      background: #c82333;
    }

    .search-filter-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      padding: 12px 15px;
      border: 2px solid #ccc;
      border-radius: 10px;
      font-size: 15px;
      transition: 0.3s ease;
    }

    .search-box:focus {
      border-color: #2c5364;
      outline: none;
      box-shadow: 0 0 6px rgba(44,83,100,0.35);
    }

    .filter-select {
      padding: 12px 15px;
      border: 2px solid #ccc;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.3s ease;
      background: white;
    }

    .filter-select:focus {
      border-color: #2c5364;
      outline: none;
    }

    .print-btn {
      background: #007bff;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
      white-space: nowrap;
    }

    .print-btn:hover {
      background: #0056b3;
      transform: scale(1.05);
    }

    .print-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .row-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin: 0;
    }

    .select-all-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .selected-row {
      background-color: #e3f2fd !important;
    }

    .selection-info {
      margin: 10px 0;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 14px;
      color: #495057;
      text-align: center;
    }

    @media print {
      .no-print {
        display: none !important;
      }
      
      .print-only {
        display: block !important;
      }
      
      table {
        page-break-inside: auto;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      body {
        background: white !important;
      }
    }

    .clear-btn {
      background: #6c757d;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.3s ease;
      white-space: nowrap;
    }

    .clear-btn:hover {
      background: #5a6268;
    }

    .results-info {
      text-align: center;
      margin: 10px 0;
      color: #666;
      font-style: italic;
    }
    
    /* Folder System Styles */
    .folder-system {
      margin-bottom: 50px;
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      border: 2px solid #dee2e6;
    }

    .folder-breadcrumb {
      margin-bottom: 20px;
      font-size: 14px;
      color: #6c757d;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .folder-breadcrumb span {
      cursor: pointer;
      color: #2c5364;
      font-weight: 600;
    }

    .folder-breadcrumb span:hover {
      text-decoration: underline;
    }

    .folder-container {
      margin-bottom: 40px;
      margin-top: 30px;
    }
    
    .folder-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 60px;
    }

    .folder {
      background: linear-gradient(135deg, #2c5364, #203a43);
      color: white;
      padding: 45px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.3s ease;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .folder:hover {
      filter: brightness(1.15);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .folder.locked {
      background: linear-gradient(135deg, #6c757d, #5a6268);
      cursor: pointer;
    }

    .folder.locked:hover {
      filter: brightness(1.15);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .folder-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .folder-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .folder-count {
      font-size: 13px;
      opacity: 0.9;
    }

    .folder-lock-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #ffc107;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s ease;
      margin-bottom: 15px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    .folder-info-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 25px 30px;
      margin-bottom: 30px;
      color: #856404;
      width: 100%;
      box-sizing: border-box;
    }
    
    .folder-info-box-wide {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px 40px;
      margin-bottom: 30px;
      color: #856404;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      z-index: 10;
    }

    .folder-info-box h4 {
      margin: 0 0 12px 0;
      font-size: 20px;
      font-weight: bold;
    }

    .folder-info-box p {
      margin: 5px 0;
      font-size: 16px;
    }
    
    .folder-info-box-wide h4 {
      margin: 0 0 10px 0;
      font-size: 22px;
      font-weight: bold;
    }

    .folder-info-box-wide p {
      margin: 5px 0;
      font-size: 17px;
      max-width: 1400px;
    }

    /* Email Button Styles */
    .email-btn {
      background: #17a2b8;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
      white-space: nowrap;
    }

    .email-btn:hover {
      background: #138496;
      transform: scale(1.05);
    }

    .email-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .email-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .email-modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .email-modal h3 {
      margin-top: 0;
      color: #2c5364;
      text-align: center;
      margin-bottom: 25px;
    }

    .email-form-group {
      margin-bottom: 20px;
    }

    .email-form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    .email-form-group input,
    .email-form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: 0.3s ease;
      box-sizing: border-box;
    }

    .email-form-group input:focus,
    .email-form-group textarea:focus {
      border-color: #17a2b8;
      outline: none;
      box-shadow: 0 0 6px rgba(23, 162, 184, 0.3);
    }

    .email-form-group textarea {
      resize: vertical;
      min-height: 120px;
    }

    .email-modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }

    .email-send-btn {
      background: #28a745;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .email-send-btn:hover {
      background: #218838;
    }

    .email-cancel-btn {
      background: #6c757d;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .email-cancel-btn:hover {
      background: #5a6268;
    }

    /* Sticky Action Box */
    .action-box {
      position: fixed;
      top: 120px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      min-width: 160px;
      max-width: 160px;
      z-index: 999;
      border: 2px solid #2c5364;
    }

    .action-box h4 {
      margin: 0 0 15px 0;
      color: #2c5364;
      font-size: 16px;
      text-align: center;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .action-box-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-box .print-btn,
    .action-box .email-btn {
      width: 100%;
      margin: 0;
    }

    @media (max-width: 1024px) {
      .action-box {
        position: static;
        margin: 20px auto;
        max-width: 400px;
      }
    }

    /* Hide columns dynamically */
    .hidden-column {
      display: none !important;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #2c5364, #203a43);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
      margin-right: 10px;
    }

    .refresh-btn:hover {
      background: linear-gradient(135deg, #203a43, #0f2027);
      transform: scale(1.05);
    }

    .status-text {
      display: inline-block;
      margin-left: 10px;
      color: #666;
      font-style: italic;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    
    th {
      background: #2c5364;
      color: white;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    th:hover {
      background: #203a43;
    }

    th.sortable::after {
      content: ' ‚áÖ';
      opacity: 0.3;
      font-size: 12px;
    }

    th.sorted-asc::after {
      content: ' ‚ñ≤';
      opacity: 1;
    }

    th.sorted-desc::after {
      content: ' ‚ñº';
      opacity: 1;
    }
    
    tr:nth-child(even) { 
      background: #f9f9f9; 
    }

    tr:hover {
      background: #f0f8ff;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(30px);}
      to {opacity: 1; transform: translateY(0);}
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-container {
        flex-direction: column;
        gap: 15px;
      }

      .nav-menu {
        gap: 15px;
      }

      .main-content {
        padding: 20px 15px;
      }

      .content-container {
        padding: 25px;
      }

      h2 {
        font-size: 24px;
      }

      .controls {
        flex-direction: column;
        gap: 15px;
      }

      .column-selector {
        max-width: 100%;
      }

      .checkbox-container {
        flex-direction: column;
        align-items: center;
      }

      .checkbox-item {
        width: 100%;
        max-width: 250px;
        justify-content: flex-start;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        üìã Detention System
      </a>
      <ul class="nav-menu">
        <li><a href="index.html" class="nav-link">Detention Form</a></li>
        <li><a href="display.html" class="nav-link active">View Data</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div class="content-container">
      <h2>üìä Detention Records</h2>
      
      
      <!-- Folder System -->
      <div class="folder-system">
        <div class="folder-breadcrumb" id="breadcrumb">
          <span onclick="navigateToRoot()">üìÅ All Records</span>
        </div>
        
        <div id="folderContainer" class="folder-container"></div>
        <button class="back-btn" id="backBtn" style="display: none;" onclick="navigateBack()">
          ‚Üê Back
        </button>
      </div>
      
      <!-- Search and Filter Controls -->
      <div class="search-filter-container" id="searchControls" style="display: none;">
        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search all fields..." oninput="filterData()">
        
        <div class="column-selector">
          <button class="column-dropdown-btn" onclick="toggleColumnDropdown()">
            üìã Select Columns to Display
          </button>
          <div class="column-dropdown-content" id="columnDropdownContent">
            <h4 class="column-dropdown-header">üìã Select Columns to Display</h4>
            <div class="checkbox-container" id="columnCheckboxes">
              <!-- Checkboxes will be dynamically generated -->
            </div>
            <div class="selector-buttons">
              <button class="select-all-btn" onclick="selectAllColumns()">Select All</button>
              <button class="select-none-btn" onclick="selectNoColumns()">Clear All</button>
            </div>
          </div>
        </div>
        
        <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
      </div>

      <div class="selection-info" id="selectionInfo" style="display: none;">
        <span id="selectedCount">0</span> record(s) selected for printing
      </div>

      <div class="status-text" id="statusText"></div>
      <div class="results-info" id="resultsInfo"></div>

      <table id="dataTable" style="display: none;">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Sticky Action Box -->
  <div class="action-box">
    <h4>üìã Actions</h4>
    <div class="action-box-buttons">
      <button class="print-btn" id="printBtn" onclick="printSelected()" disabled>üñ®Ô∏è Print Selected</button>
      <button class="email-btn" id="emailBtn" onclick="openEmailModal()" disabled>üìß Send Email</button>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" class="email-modal">
    <div class="email-modal-content" style="max-width: 900px;">
      <h3>üìß Send Detention Notification</h3>
      <form id="emailForm">
        <div class="email-form-group">
          <label for="emailToStudent">To (Student Email): *</label>
          <input type="email" id="emailToStudent" required placeholder="student@cttech.org">
        </div>
        <div class="email-form-group">
          <label for="emailToParent">To (Parent/Guardian Email): *</label>
          <input type="email" id="emailToParent" required placeholder="parent@example.com">
        </div>
        <div class="email-form-group">
          <label for="emailSubject">Subject: *</label>
          <input type="text" id="emailSubject" required placeholder="Important: Detention Notification">
        </div>
        
        <!-- Teacher Customization Fields -->
        <fieldset style="border: 2px solid #2c5364; border-radius: 8px; padding: 15px; margin: 15px 0; background: #f8f9fa;">
          <legend style="font-weight: bold; color: #2c5364; padding: 0 10px;">üìù Required Information (Fill In)</legend>
          
          <div class="email-form-group">
            <label for="parentName">Parent/Guardian Name: *</label>
            <input type="text" id="parentName" required placeholder="e.g., Mr. Smith or Mrs. Johnson">
            <small style="color: #666; display: block; margin-top: 5px;">Enter how you'd like to address the parent (formal/informal)</small>
          </div>
          
          <div class="email-form-group">
            <label for="detentionRoom">Detention Room/Location: *</label>
            <input type="text" id="detentionRoom" required placeholder="e.g., Room 204 or Main Office">
          </div>
          
          <div class="email-form-group">
            <label for="detentionTime">Detention Time: *</label>
            <input type="text" id="detentionTime" required placeholder="e.g., 3:00 PM - 4:00 PM">
          </div>
          
          <div class="email-form-group">
            <label for="additionalContext">Additional Context (Optional):</label>
            <textarea id="additionalContext" rows="2" placeholder="Any specific details about the incident or expectations (optional)"></textarea>
          </div>
        </fieldset>
        
        <!-- Rhetorical Balance Controls -->
        <fieldset style="border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin: 15px 0; background: linear-gradient(135deg, #f8f9ff, #fff);">
          <legend style="font-weight: bold; color: #667eea; padding: 0 10px;">üéØ Rhetorical Balance Controls</legend>
          <p style="color: #666; font-size: 14px; margin-bottom: 15px; text-align: center;">Adjust the emphasis of your message. All four sliders must total <strong>100%</strong>.</p>
          
          <!-- Ethos Slider -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <label style="font-weight: bold; color: #2c5364;">üíº Ethos (Credibility & Authority)</label>
              <span id="ethosValue" style="font-weight: bold; color: #2c5364; font-size: 18px;">25%</span>
            </div>
            <input type="range" id="ethosSlider" min="0" max="100" value="25" oninput="updateRhetoricalBalance()" style="width: 100%; height: 8px; border-radius: 5px; background: linear-gradient(to right, #3498db 0%, #3498db 25%, #e0e0e0 25%, #e0e0e0 100%); outline: none; appearance: none; cursor: pointer;">
            <small style="color: #666; display: block; margin-top: 3px;">Professional expertise, research-backed statements, institutional credibility</small>
          </div>
          
          <!-- Pathos Slider -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <label style="font-weight: bold; color: #2c5364;">‚ù§Ô∏è Pathos (Emotion & Connection)</label>
              <span id="pathosValue" style="font-weight: bold; color: #2c5364; font-size: 18px;">25%</span>
            </div>
            <input type="range" id="pathosSlider" min="0" max="100" value="25" oninput="updateRhetoricalBalance()" style="width: 100%; height: 8px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #e74c3c 25%, #e0e0e0 25%, #e0e0e0 100%); outline: none; appearance: none; cursor: pointer;">
            <small style="color: #666; display: block; margin-top: 3px;">Empathy, care, emotional understanding, supportive language</small>
          </div>
          
          <!-- Logos Slider -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <label style="font-weight: bold; color: #2c5364;">üß† Logos (Logic & Reasoning)</label>
              <span id="logosValue" style="font-weight: bold; color: #2c5364; font-size: 18px;">25%</span>
            </div>
            <input type="range" id="logosSlider" min="0" max="100" value="25" oninput="updateRhetoricalBalance()" style="width: 100%; height: 8px; border-radius: 5px; background: linear-gradient(to right, #2ecc71 0%, #2ecc71 25%, #e0e0e0 25%, #e0e0e0 100%); outline: none; appearance: none; cursor: pointer;">
            <small style="color: #666; display: block; margin-top: 3px;">Facts, data, cause-and-effect reasoning, logical arguments</small>
          </div>
          
          <!-- General Slider -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <label style="font-weight: bold; color: #2c5364;">üìù General (Neutral Professional)</label>
              <span id="generalValue" style="font-weight: bold; color: #2c5364; font-size: 18px;">25%</span>
            </div>
            <input type="range" id="generalSlider" min="0" max="100" value="25" oninput="updateRhetoricalBalance()" style="width: 100%; height: 8px; border-radius: 5px; background: linear-gradient(to right, #95a5a6 0%, #95a5a6 25%, #e0e0e0 25%, #e0e0e0 100%); outline: none; appearance: none; cursor: pointer;">
            <small style="color: #666; display: block; margin-top: 3px;">Straightforward information, neutral tone, standard professional writing</small>
          </div>
          
          <!-- Total Display -->
          <div id="balanceWarning" style="text-align: center; padding: 12px; border-radius: 8px; margin-top: 15px; font-weight: bold; background: #d4edda; color: #155724; border: 2px solid #c3e6cb;">
            ‚úÖ Total: <span id="totalPercentage">100</span>% (Perfect Balance)
          </div>
          
          <!-- Quick Presets -->
          <div style="margin-top: 20px; text-align: center;">
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;"><strong>Quick Presets:</strong></p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
              <button type="button" onclick="setPreset('balanced')" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">‚öñÔ∏è Balanced</button>
              <button type="button" onclick="setPreset('authoritative')" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">üíº Authoritative</button>
              <button type="button" onclick="setPreset('compassionate')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">‚ù§Ô∏è Compassionate</button>
              <button type="button" onclick="setPreset('analytical')" style="padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">üß† Analytical</button>
              <button type="button" onclick="setPreset('straightforward')" style="padding: 8px 16px; background: #7f8c8d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">üìù Straightforward</button>
            </div>
          </div>
          
          <!-- Generate Button -->
          <div style="text-align: center; margin-top: 25px;">
            <button type="button" id="generateBtn" onclick="generateAIEmail()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 16px 40px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s ease; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);">
              ‚ú® Generate AI Email with Custom Balance
            </button>
            <br>
            <small style="color: #666; display: block; margin-top: 10px;">Generates a completely unique, professional message based on your rhetorical preferences</small>
          </div>
        </fieldset>
        
        <!-- AI Generated Message Section -->
        <div id="messageSection" style="display: none;">
          <!-- Rhetorical Composition Analysis -->
          <div style="background: linear-gradient(135deg, #f8f9ff, #fff); border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #667eea; text-align: center; font-size: 16px;">üìä Message Composition Analysis</h4>
            
            <!-- Ethos Bar -->
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold; color: #3498db; font-size: 13px;">üíº Ethos (Credibility)</span>
                <span id="messageEthosPercent" style="font-weight: bold; color: #3498db; font-size: 13px;">0%</span>
              </div>
              <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; border: 1px solid #ccc;">
                <div id="messageEthosBar" style="height: 100%; background: linear-gradient(90deg, #3498db, #5dade2); width: 0%; transition: width 0.5s ease;"></div>
              </div>
            </div>
            
            <!-- Pathos Bar -->
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold; color: #e74c3c; font-size: 13px;">‚ù§Ô∏è Pathos (Emotion)</span>
                <span id="messagePathosPercent" style="font-weight: bold; color: #e74c3c; font-size: 13px;">0%</span>
              </div>
              <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; border: 1px solid #ccc;">
                <div id="messagePathosBar" style="height: 100%; background: linear-gradient(90deg, #e74c3c, #ec7063); width: 0%; transition: width 0.5s ease;"></div>
              </div>
            </div>
            
            <!-- Logos Bar -->
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold; color: #2ecc71; font-size: 13px;">üß† Logos (Logic)</span>
                <span id="messageLogosPercent" style="font-weight: bold; color: #2ecc71; font-size: 13px;">0%</span>
              </div>
              <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; border: 1px solid #ccc;">
                <div id="messageLogosBar" style="height: 100%; background: linear-gradient(90deg, #2ecc71, #58d68d); width: 0%; transition: width 0.5s ease;"></div>
              </div>
            </div>
            
            <!-- General Bar -->
            <div style="margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold; color: #95a5a6; font-size: 13px;">üìù General (Neutral)</span>
                <span id="messageGeneralPercent" style="font-weight: bold; color: #95a5a6; font-size: 13px;">0%</span>
              </div>
              <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; border: 1px solid #ccc;">
                <div id="messageGeneralBar" style="height: 100%; background: linear-gradient(90deg, #95a5a6, #b2babb); width: 0%; transition: width 0.5s ease;"></div>
              </div>
            </div>
            
            <p style="text-align: center; margin: 15px 0 0 0; font-size: 12px; color: #666; font-style: italic;">This analysis reflects the rhetorical balance of your generated message</p>
          </div>
          
          <div class="email-form-group">
            <label for="emailMessage">AI-Generated Professional Message:</label>
            <textarea id="emailMessage" rows="22" style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.7; background: white; font-size: 14px;"></textarea>
            <small style="color: #666; display: block; margin-top: 5px;">
              üí° <strong>Tip:</strong> You can edit this message directly, regenerate with different settings, or send it as-is.
            </small>
          </div>
          
          <div class="email-modal-buttons" style="flex-wrap: wrap;">
            <button type="button" class="email-send-btn" onclick="sendEmail()" style="background: #28a745;">
              üì§ Send Email
            </button>
            <button type="button" onclick="generateAIEmail()" style="background: #17a2b8; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s ease;">
              üîÑ Regenerate New Version
            </button>
            <button type="button" class="email-cancel-btn" onclick="closeEmailModal()">
              ‚ùå Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    const sheetURL = "https://script.google.com/macros/s/AKfycbw9DOPHFSUSnv7KpYhT8y3-rjrTuBCSPIQxFVOA_yWF2PwEYqFPq-ZtjjwviAS5Z7d68w/exec"; // Replace with your Apps Script URL
    let allData = []; // Store all data
    let filteredData = []; // Store filtered data
    let headers = []; // Store headers
    let visibleColumns = []; // Track which columns are visible
    let sortColumn = -1; // Current sort column
    let sortAscending = true; // Sort direction
    
    // Folder navigation state
    let currentView = 'root'; // 'root', 'schoolYear', 'grade'
    let currentSchoolYear = null;
    let currentGrade = null;
    let folderStructure = {};

    // Get current school year based on date (Aug 25 - Jun 27)
    function getCurrentSchoolYear() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // 1-12
      const day = now.getDate();
      
      // School year starts Aug 25 and ends Jun 27
      if (month >= 8 || (month <= 6 && day <= 27)) {
        if (month >= 8) {
          return `${year.toString().slice(-2)}-${(year + 1).toString().slice(-2)}`;
        } else {
          return `${(year - 1).toString().slice(-2)}-${year.toString().slice(-2)}`;
        }
      } else {
        return `${year.toString().slice(-2)}-${(year + 1).toString().slice(-2)}`;
      }
    }

    // Check if a school year is locked (past Jun 27 of the ending year)
    function isSchoolYearLocked(schoolYear) {
      const [startYear, endYear] = schoolYear.split('-').map(y => parseInt('20' + y));
      const lockDate = new Date(endYear, 5, 27); // June 27 (month is 0-indexed)
      const now = new Date();
      return now > lockDate;
    }

    // Build folder structure from data
    function buildFolderStructure() {
      folderStructure = {};
      
      if (!allData || allData.length <= 1) return;
      
      const gradeIndex = headers.indexOf("Grade");
      const dateIndex = headers.indexOf("Incident Date");
      
      if (gradeIndex === -1) return;
      
      // Process each record
      for (let i = 1; i < allData.length; i++) {
        const row = allData[i];
        const grade = row[gradeIndex];
        
        // Determine school year from incident date
        let schoolYear = getCurrentSchoolYear();
        if (dateIndex !== -1 && row[dateIndex]) {
          const dateValue = row[dateIndex];
          let incidentDate;
          
          if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(dateValue)) {
            incidentDate = new Date(dateValue);
          } else if (typeof dateValue === 'string') {
            incidentDate = new Date(dateValue);
          }
          
          if (incidentDate && !isNaN(incidentDate.getTime())) {
            const year = incidentDate.getFullYear();
            const month = incidentDate.getMonth() + 1;
            
            if (month >= 8) {
              schoolYear = `${year.toString().slice(-2)}-${(year + 1).toString().slice(-2)}`;
            } else {
              schoolYear = `${(year - 1).toString().slice(-2)}-${year.toString().slice(-2)}`;
            }
          }
        }
        
        // Initialize structure
        if (!folderStructure[schoolYear]) {
          folderStructure[schoolYear] = {
            Freshman: [],
            Sophomore: [],
            Junior: [],
            Senior: []
          };
        }
        
        // Add record to appropriate grade
        if (grade && folderStructure[schoolYear][grade]) {
          folderStructure[schoolYear][grade].push(row);
        }
      }
    }

    // Navigate to root view (show school year folders)
    function navigateToRoot() {
      currentView = 'root';
      currentSchoolYear = null;
      currentGrade = null;
      
      document.getElementById('searchControls').style.display = 'none';
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('backBtn').style.display = 'none';
      document.getElementById('selectionInfo').style.display = 'none';
      
      updateBreadcrumb();
      
      // Show current school year folder immediately, even before data loads
      if (!allData) {
        const container = document.getElementById('folderContainer');
        const currentSY = getCurrentSchoolYear();
        container.innerHTML = `
          <div class="folder-grid">
            <div class="folder" onclick="navigateToSchoolYear('${currentSY}')">
              <div class="folder-icon">üìÖ</div>
              <div class="folder-name">${currentSY}</div>
              <div class="folder-count">Loading...</div>
            </div>
          </div>
        `;
      } else {
        displaySchoolYearFolders();
      }
    }

    // Navigate back
    function navigateBack() {
      if (currentView === 'grade') {
        navigateToSchoolYear(currentSchoolYear);
      } else if (currentView === 'schoolYear') {
        navigateToRoot();
      }
    }

    // Navigate to school year (show grade folders)
    function navigateToSchoolYear(schoolYear) {
      currentView = 'schoolYear';
      currentSchoolYear = schoolYear;
      currentGrade = null;
      
      document.getElementById('searchControls').style.display = 'none';
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('backBtn').style.display = 'inline-flex';
      document.getElementById('selectionInfo').style.display = 'none';
      
      updateBreadcrumb();
      displayGradeFolders(schoolYear);
    }

    // Navigate to grade (show records table)
    function navigateToGrade(schoolYear, grade) {
      currentView = 'grade';
      currentSchoolYear = schoolYear;
      currentGrade = grade;
      
      document.getElementById('searchControls').style.display = 'flex';
      document.getElementById('dataTable').style.display = 'table';
      document.getElementById('backBtn').style.display = 'inline-flex';
      
      updateBreadcrumb();
      displayGradeRecords(schoolYear, grade);
    }

    // Update breadcrumb navigation
    function updateBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumb');
      let html = '<span onclick="navigateToRoot()">üìÅ All Records</span>';
      
      if (currentSchoolYear) {
        html += ' / <span onclick="navigateToSchoolYear(\'' + currentSchoolYear + '\')">üìÖ ' + currentSchoolYear + '</span>';
      }
      
      if (currentGrade) {
        html += ' / <span>üë§ ' + currentGrade + '</span>';
      }
      
      breadcrumb.innerHTML = html;
    }

    // Display school year folders
    function displaySchoolYearFolders() {
      const container = document.getElementById('folderContainer');
      const currentSY = getCurrentSchoolYear();
      
      // Get all school years and sort them
      const schoolYears = Object.keys(folderStructure).sort((a, b) => {
        const [aStart] = a.split('-').map(y => parseInt(y));
        const [bStart] = b.split('-').map(y => parseInt(y));
        return bStart - aStart; // Most recent first
      });
      
      let html = '<div class="folder-grid">';
      
      // Always show current school year even if no data
      if (!schoolYears.includes(currentSY)) {
        const isLocked = isSchoolYearLocked(currentSY);
        const lockIcon = isLocked ? '<div class="folder-lock-icon">üîí</div>' : '';
        
        html += `
          <div class="folder ${isLocked ? 'locked' : ''}" onclick="navigateToSchoolYear('${currentSY}')">
            ${lockIcon}
            <div class="folder-icon">üìÅ</div>
            <div class="folder-name">${currentSY}</div>
            <div class="folder-count">0 records</div>
          </div>
        `;
      }
      
      // Display existing school years
      schoolYears.forEach(schoolYear => {
        const isLocked = isSchoolYearLocked(schoolYear);
        const lockIcon = isLocked ? '<div class="folder-lock-icon">üîí</div>' : '';
        
        // Count total records in this school year
        let totalRecords = 0;
        Object.keys(folderStructure[schoolYear]).forEach(grade => {
          totalRecords += folderStructure[schoolYear][grade].length;
        });
        
        html += `
          <div class="folder ${isLocked ? 'locked' : ''}" onclick="navigateToSchoolYear('${schoolYear}')">
            ${lockIcon}
            <div class="folder-icon">üìÅ</div>
            <div class="folder-name">${schoolYear}</div>
            <div class="folder-count">${totalRecords} record${totalRecords !== 1 ? 's' : ''}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      if (html === '<div class="folder-grid"></div>') {
        html = '<div class="folder-info-box"><h4>No Data Available</h4><p>No detention records found. Submit a form to create records.</p></div>';
      }
      
      container.innerHTML = html;
    }

    // Display grade folders for a school year
    function displayGradeFolders(schoolYear) {
      const container = document.getElementById('folderContainer');
      const isLocked = isSchoolYearLocked(schoolYear);
      const grades = ['Freshman', 'Sophomore', 'Junior', 'Senior'];
      
      // Calculate graduation years based on school year
      const endYear = parseInt(schoolYear.split('-')[1]) + 2000;
      const gradeLabels = {
        'Freshman': `Freshman (9th Grade, Class of '${(endYear + 3).toString().slice(-2)})`,
        'Sophomore': `Sophomore (10th Grade, Class of '${(endYear + 2).toString().slice(-2)})`,
        'Junior': `Junior (11th Grade, Class of '${(endYear + 1).toString().slice(-2)})`,
        'Senior': `Senior (12th Grade, Class of '${endYear.toString().slice(-2)})`
      };
      
      let html = '';
      
      if (isLocked) {
        html += `
          <div class="folder-info-box-wide">
            <h4>üîí Archived School Year</h4>
            <p>This school year is archived and locked. Records are viewable but no new entries can be added.</p>
            <p><strong>Year:</strong> ${schoolYear} (Aug 25 - Jun 27)</p>
          </div>
        `;
      }
      
      html += '<div class="folder-grid">';
      
      grades.forEach(grade => {
        // Check if folderStructure exists for this school year, if not default to 0
        const recordCount = folderStructure[schoolYear] && folderStructure[schoolYear][grade] 
          ? folderStructure[schoolYear][grade].length 
          : 0;
        
        html += `
          <div class="folder" onclick="navigateToGrade('${schoolYear}', '${grade}')">
            <div class="folder-icon">üë•</div>
            <div class="folder-name">${gradeLabels[grade]}</div>
            <div class="folder-count">${recordCount} record${recordCount !== 1 ? 's' : ''}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    // Show locked message
    function showLockedMessage(schoolYear) {
      alert(`The school year ${schoolYear} is locked and archived. Records are read-only after June 27th of the ending year.`);
    }

    // Display records for a specific grade in a school year
    function displayGradeRecords(schoolYear, grade) {
      const container = document.getElementById('folderContainer');
      const isLocked = isSchoolYearLocked(schoolYear);
      
      let html = '';
      
      if (isLocked) {
        html += `
          <div class="folder-info-box-wide">
            <h4>üîí Archived Records - Read Only Access</h4>
            <p>Currently viewing <strong>${grade}</strong> detention records from school year <strong>${schoolYear}</strong>. This academic year is locked and archived (locked after June 27th). All records remain viewable but no new entries can be added to this year.</p>
          </div>
        `;
      } else {
        html += `
          <div class="folder-info-box-wide">
            <h4>üìä Active Records - Current School Year</h4>
            <p>Currently viewing <strong>${grade}</strong> detention records from the active school year <strong>${schoolYear}</strong>. You can view, search, print, and email notifications for these records. New submissions will be added to this folder until June 27th of the ending year.</p>
          </div>
        `;
      }
      
      container.innerHTML = html;
      
      // Filter data to show only this grade and school year
      if (folderStructure[schoolYear] && folderStructure[schoolYear][grade]) {
        filteredData = folderStructure[schoolYear][grade];
      } else {
        filteredData = [];
      }
      
      displayTable();
      updateResultsInfo();
      document.getElementById('selectionInfo').style.display = 'none';
    }

    // Toggle column dropdown visibility
    function toggleColumnDropdown() {
      const dropdown = document.getElementById("columnDropdownContent");
      const button = document.querySelector(".column-dropdown-btn");
      
      dropdown.classList.toggle("show");
      button.classList.toggle("active");
    }

    // Close dropdown when clicking outside
    window.onclick = function(event) {
      if (!event.target.matches('.column-dropdown-btn')) {
        const dropdowns = document.getElementsByClassName("column-dropdown-content");
        for (let i = 0; i < dropdowns.length; i++) {
          const openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
            document.querySelector(".column-dropdown-btn").classList.remove('active');
          }
        }
      }
    }

    async function loadData() {
      const statusText = document.getElementById("statusText");
      
      // Show folder structure immediately
      navigateToRoot();
      
      statusText.textContent = "Loading records...";
      statusText.style.color = "#2c5364";

      try {
        const response = await fetch(sheetURL);
        const data = await response.json();
        allData = data; // Store all data

        // First row = headers
        headers = data[0];
        
        // Initialize visible columns (all visible by default on first load)
        if (visibleColumns.length === 0) {
          visibleColumns = headers.map((_, index) => index);
        }

        // Build folder structure
        buildFolderStructure();
        
        // Update the view with actual data
        if (currentView === 'root') {
          navigateToRoot();
        } else if (currentView === 'schoolYear' && currentSchoolYear) {
          navigateToSchoolYear(currentSchoolYear);
        } else if (currentView === 'grade' && currentSchoolYear && currentGrade) {
          navigateToGrade(currentSchoolYear, currentGrade);
        } else {
          navigateToRoot();
        }
        
        createColumnCheckboxes(); // Create checkboxes for column selection

        statusText.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        statusText.style.color = "#28a745";

      } catch (err) {
        console.error("Error loading data:", err);
        statusText.textContent = "Error loading data. Please try again.";
        statusText.style.color = "#dc3545";
      }
    }

    function createColumnCheckboxes() {
      const container = document.getElementById("columnCheckboxes");
      container.innerHTML = "";

      headers.forEach((header, index) => {
        const checkboxItem = document.createElement("div");
        checkboxItem.className = "checkbox-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `col-${index}`;
        checkbox.checked = visibleColumns.includes(index);
        checkbox.onchange = () => toggleColumn(index);

        const label = document.createElement("label");
        label.htmlFor = `col-${index}`;
        label.textContent = header;

        checkboxItem.appendChild(checkbox);
        checkboxItem.appendChild(label);
        container.appendChild(checkboxItem);
      });
    }

    function toggleColumn(columnIndex) {
      const checkbox = document.getElementById(`col-${columnIndex}`);
      
      if (checkbox.checked) {
        if (!visibleColumns.includes(columnIndex)) {
          visibleColumns.push(columnIndex);
          visibleColumns.sort((a, b) => a - b); // Keep original order
        }
      } else {
        visibleColumns = visibleColumns.filter(col => col !== columnIndex);
      }

      displayTable();
      updateResultsInfo();
    }

    function displayTable() {
      const table = document.getElementById("dataTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");

      thead.innerHTML = "";
      tbody.innerHTML = "";

      if (visibleColumns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 20px; color: #666;">Please select at least one column to display</td></tr>';
        return;
      }

      // Create header row with checkbox column and visible columns
      const headerRow = document.createElement("tr");
      
      // Add select all checkbox column
      const selectAllTh = document.createElement("th");
      selectAllTh.style.width = "40px";
      selectAllTh.innerHTML = '<input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox" onchange="toggleAllRows()">';
      headerRow.appendChild(selectAllTh);
      
      visibleColumns.forEach(colIndex => {
        const th = document.createElement("th");
        th.textContent = headers[colIndex];
        th.className = "sortable";
        th.onclick = () => sortTable(colIndex);
        
        // Add sort indicator if this column is sorted
        if (sortColumn === colIndex) {
          th.classList.add(sortAscending ? "sorted-asc" : "sorted-desc");
        }
        
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Create data rows with checkbox column and visible columns
      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + (visibleColumns.length + 1) + '" style="text-align: center; padding: 20px; color: #666;">No records match the current filters</td></tr>';
        return;
      }

      filteredData.forEach((rowData, rowIndex) => {
        const row = document.createElement("tr");
        row.dataset.rowIndex = rowIndex;
        
        // Add checkbox column
        const checkboxTd = document.createElement("td");
        checkboxTd.innerHTML = '<input type="checkbox" class="row-checkbox" onchange="updateSelection()">';
        row.appendChild(checkboxTd);
        
        visibleColumns.forEach(colIndex => {
          const td = document.createElement("td");
          const cellValue = rowData[colIndex] || "";
          
          // Check if this looks like an ISO datetime string and format it
          if (typeof cellValue === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(cellValue)) {
            const date = new Date(cellValue);
            td.textContent = date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit' 
            });
          } else {
            td.textContent = cellValue;
          }
          
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
    }

    function populateFilters() {
      // Find indices of Main Type and Period columns
      const mainTypeIndex = headers.indexOf("Main Type");
      const periodIndex = headers.indexOf("Period");

      // Populate Main Type filter
      if (mainTypeIndex !== -1) {
        const mainTypeFilter = document.getElementById("mainTypeFilter");
        const mainTypes = new Set();
        
        for (let i = 1; i < allData.length; i++) {
          if (allData[i][mainTypeIndex]) {
            mainTypes.add(allData[i][mainTypeIndex]);
          }
        }
        
        mainTypeFilter.innerHTML = '<option value="">All Main Types</option>';
        [...mainTypes].sort().forEach(type => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          mainTypeFilter.appendChild(option);
        });
      }

      // Populate Period filter
      if (periodIndex !== -1) {
        const periodFilter = document.getElementById("periodFilter");
        const periods = new Set();
        
        for (let i = 1; i < allData.length; i++) {
          if (allData[i][periodIndex]) {
            periods.add(allData[i][periodIndex]);
          }
        }
        
        periodFilter.innerHTML = '<option value="">All Periods</option>';
        [...periods].sort((a, b) => {
          const numA = parseInt(a);
          const numB = parseInt(b);
          return numA - numB;
        }).forEach(period => {
          const option = document.createElement("option");
          option.value = period;
          option.textContent = "Period " + period;
          periodFilter.appendChild(option);
        });
      }
    }

    function filterData() {
      const searchTerm = document.getElementById("searchBox").value.toLowerCase();

      // Start with current folder's data
      let baseData = [];
      if (currentView === 'grade' && currentSchoolYear && currentGrade) {
        if (folderStructure[currentSchoolYear] && folderStructure[currentSchoolYear][currentGrade]) {
          baseData = folderStructure[currentSchoolYear][currentGrade];
        }
      } else {
        return; // Only filter when viewing a specific grade
      }

      filteredData = baseData.filter(row => {
        // Search filter - check only visible columns
        const matchesSearch = searchTerm === "" || 
          visibleColumns.some(colIndex => String(row[colIndex] || "").toLowerCase().includes(searchTerm));

        return matchesSearch;
      });

      displayTable();
      updateResultsInfo();
    }

    function clearFilters() {
      document.getElementById("searchBox").value = "";
      document.getElementById("mainTypeFilter").value = "";
      document.getElementById("periodFilter").value = "";
      filterData();
    }

    function sortTable(columnIndex) {
      // Toggle sort direction if clicking same column
      if (sortColumn === columnIndex) {
        sortAscending = !sortAscending;
      } else {
        sortColumn = columnIndex;
        sortAscending = true;
      }

      filteredData.sort((a, b) => {
        let aVal = a[columnIndex] || "";
        let bVal = b[columnIndex] || "";

        // Try to parse as numbers
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);

        if (!isNaN(aNum) && !isNaN(bNum)) {
          return sortAscending ? aNum - bNum : bNum - aNum;
        }

        // String comparison
        aVal = String(aVal).toLowerCase();
        bVal = String(bVal).toLowerCase();

        if (sortAscending) {
          return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
          return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
      });

      displayTable();
    }

    function exportToCSV() {
      if (filteredData.length === 0) {
        alert("No data to export!");
        return;
      }

      let csv = "";

      // Add headers (only visible columns)
      csv += visibleColumns.map(colIndex => `"${headers[colIndex]}"`).join(",") + "\n";

      // Add data rows (only visible columns)
      filteredData.forEach(row => {
        csv += visibleColumns.map(colIndex => {
          let cell = row[colIndex] || "";
          
          // Check if this looks like an ISO datetime string and format it
          if (typeof cell === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(cell)) {
            const date = new Date(cell);
            cell = date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit' 
            });
          }
          
          return `"${String(cell).replace(/"/g, '""')}"`;
        }).join(",") + "\n";
      });

      // Create download link
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      
      link.setAttribute("href", url);
      link.setAttribute("download", `detention_records_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = "hidden";
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function selectAllColumns() {
      visibleColumns = headers.map((_, index) => index);
      
      // Update all checkboxes
      headers.forEach((_, index) => {
        const checkbox = document.getElementById(`col-${index}`);
        if (checkbox) checkbox.checked = true;
      });

      displayTable();
      updateResultsInfo();
    }

    function selectNoColumns() {
      visibleColumns = [];
      
      // Update all checkboxes
      headers.forEach((_, index) => {
        const checkbox = document.getElementById(`col-${index}`);
        if (checkbox) checkbox.checked = false;
      });

      displayTable();
      updateResultsInfo();
    }

    function updateResultsInfo() {
      const resultsInfo = document.getElementById("resultsInfo");
      const totalRecords = allData.length > 0 ? allData.length - 1 : 0; // Exclude header
      const filteredRecords = filteredData.length;
      const visibleColumnsCount = visibleColumns.length;
      const totalColumnsCount = headers.length;

      let recordsText = "";
      if (filteredRecords === totalRecords) {
        recordsText = `${totalRecords} records`;
      } else {
        recordsText = `${filteredRecords} of ${totalRecords} records`;
      }

      if (visibleColumnsCount === 0) {
        resultsInfo.textContent = `${recordsText} ‚Ä¢ No columns selected`;
      } else if (visibleColumnsCount === totalColumnsCount) {
        resultsInfo.textContent = `${recordsText} ‚Ä¢ Showing all ${totalColumnsCount} columns`;
      } else {
        resultsInfo.textContent = `${recordsText} ‚Ä¢ Showing ${visibleColumnsCount} of ${totalColumnsCount} columns`;
      }
    }

    // Selection and Print Functions
    function toggleAllRows() {
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      const rowCheckboxes = document.querySelectorAll(".row-checkbox");
      
      rowCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        if (selectAllCheckbox.checked) {
          checkbox.closest('tr').classList.add('selected-row');
        } else {
          checkbox.closest('tr').classList.remove('selected-row');
        }
      });
      
      updateSelection();
    }

    function updateSelection() {
      const rowCheckboxes = document.querySelectorAll(".row-checkbox");
      const selectedCheckboxes = document.querySelectorAll(".row-checkbox:checked");
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      const printBtn = document.getElementById("printBtn");
      const emailBtn = document.getElementById("emailBtn");
      const selectionInfo = document.getElementById("selectionInfo");
      const selectedCount = document.getElementById("selectedCount");
      
      // Update row highlighting
      rowCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          checkbox.closest('tr').classList.add('selected-row');
        } else {
          checkbox.closest('tr').classList.remove('selected-row');
        }
      });
      
      // Update select all checkbox
      if (selectedCheckboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
      } else if (selectedCheckboxes.length === rowCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
      } else {
        selectAllCheckbox.indeterminate = true;
      }
      
      // Update print button and selection info
      if (selectedCheckboxes.length > 0) {
        printBtn.disabled = false;
        selectionInfo.style.display = "block";
        selectedCount.textContent = selectedCheckboxes.length;
      } else {
        printBtn.disabled = true;
        selectionInfo.style.display = "none";
      }
      
      // Update email button - only enable if exactly 1 record is selected
      if (selectedCheckboxes.length === 1) {
        emailBtn.disabled = false;
      } else {
        emailBtn.disabled = true;
      }
    }

    function printSelected() {
      const selectedCheckboxes = document.querySelectorAll(".row-checkbox:checked");
      
      if (selectedCheckboxes.length === 0) {
        alert("Please select at least one record to print.");
        return;
      }
      
      // Get selected row data
      const selectedRows = [];
      selectedCheckboxes.forEach(checkbox => {
        const rowIndex = parseInt(checkbox.closest('tr').dataset.rowIndex);
        selectedRows.push(filteredData[rowIndex]);
      });
      
      // Create print window content
      let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Detention Records - Print</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              margin: 20px; 
              background: white;
            }
            h1 { 
              text-align: center; 
              color: #2c5364; 
              margin-bottom: 30px;
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin-bottom: 20px;
            }
            th, td { 
              border: 1px solid #333; 
              padding: 8px; 
              text-align: left; 
              font-size: 12px;
            }
            th { 
              background-color: #f5f5f5; 
              font-weight: bold; 
            }
            tr:nth-child(even) { 
              background-color: #f9f9f9; 
            }
            .footer { 
              text-align: center; 
              margin-top: 30px; 
              font-size: 10px; 
              color: #666; 
            }
          </style>
        </head>
        <body>
          <h1>üìä Detention Records</h1>
          <table>
            <thead>
              <tr>
      `;
      
      // Add headers (only visible columns)
      visibleColumns.forEach(colIndex => {
        printContent += `<th>${headers[colIndex]}</th>`;
      });
      
      printContent += `
              </tr>
            </thead>
            <tbody>
      `;
      
      // Add selected rows data (only visible columns)
      selectedRows.forEach(rowData => {
        printContent += '<tr>';
        visibleColumns.forEach(colIndex => {
          let cellValue = rowData[colIndex] || "";
          
          // Format dates if needed
          if (typeof cellValue === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(cellValue)) {
            const date = new Date(cellValue);
            cellValue = date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit' 
            });
          }
          
          printContent += `<td>${cellValue}</td>`;
        });
        printContent += '</tr>';
      });
      
      printContent += `
            </tbody>
          </table>
          <div class="footer">
            Printed on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}<br>
            ${selectedRows.length} record(s) selected for printing
          </div>
        </body>
        </html>
      `;
      
      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    // Load data on page load
    loadData();
    

    // Email Functions
    function openEmailModal() {
      // Get the selected record
      const selectedCheckboxes = document.querySelectorAll(".row-checkbox:checked");
      
      if (selectedCheckboxes.length !== 1) {
        alert("Please select exactly one record to send an email notification.");
        return;
      }
      
      const selectedRow = selectedCheckboxes[0].closest('tr');
      const rowIndex = parseInt(selectedRow.dataset.rowIndex);
      const recordData = filteredData[rowIndex];
      
      // Extract field values from the selected record
      const studentNameIndex = headers.findIndex(h => h.toLowerCase().includes('student name'));
      const studentIdIndex = headers.findIndex(h => h.toLowerCase().includes('student id'));
      const gradeIndex = headers.findIndex(h => h.toLowerCase().includes('grade'));
      const dateIndex = headers.findIndex(h => h.toLowerCase().includes('incident date'));
      const mainTypeIndex = headers.findIndex(h => h.toLowerCase().includes('main type'));
      const subTypeIndex = headers.findIndex(h => h.toLowerCase().includes('sub type'));
      const periodIndex = headers.findIndex(h => h.toLowerCase().includes('period'));
      const locationIndex = headers.findIndex(h => h.toLowerCase().includes('location'));
      const teacherNameIndex = headers.findIndex(h => h.toLowerCase().includes('teacher name'));
      const teacherEmailIndex = headers.findIndex(h => h.toLowerCase().includes('teacher email'));
      
      const studentName = recordData[studentNameIndex] || "the student";
      const studentId = recordData[studentIdIndex] || "";
      const grade = recordData[gradeIndex] || "";
      const mainType = recordData[mainTypeIndex] || "behavioral concern";
      const subType = recordData[subTypeIndex] || "the assigned reason";
      const period = recordData[periodIndex] || "";
      const location = recordData[locationIndex] || "the classroom";
      const teacherName = recordData[teacherNameIndex] || "School Staff";
      const teacherEmail = recordData[teacherEmailIndex] || "";
      
      // Format the incident date properly
      let incidentDate = "the assigned date";
      if (dateIndex !== -1 && recordData[dateIndex]) {
        const dateValue = recordData[dateIndex];
        if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(dateValue)) {
          const date = new Date(dateValue);
          incidentDate = date.toLocaleDateString('en-US', { 
            weekday: 'long',
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
        } else {
          incidentDate = dateValue;
        }
      }
      
      // Get student first name for personalization
      const studentFirstName = studentName.split(' ')[0] || studentName;
      
      // Store data for message generation
      window.currentDetentionData = {
        studentName,
        studentFirstName,
        studentId,
        grade,
        incidentDate,
        mainType,
        subType,
        period,
        location,
        teacherName,
        teacherEmail
      };
      
      const modal = document.getElementById("emailModal");
      modal.style.display = "block";
      
      // Auto-generate student email from name
      let studentEmail = "";
      if (studentName && studentName !== "the student") {
        const nameParts = studentName.trim().split(/\s+/);
        if (nameParts.length >= 2) {
          const firstName = nameParts[0].toLowerCase();
          const lastName = nameParts[nameParts.length - 1].toLowerCase();
          studentEmail = `${firstName}.${lastName}@cttech.org`;
        }
      }
      
      document.getElementById("emailToStudent").value = studentEmail;
      document.getElementById("emailSubject").value = `Important: Detention Notification for ${studentName}`;
      
      // Add event listeners - remove auto-update, only manual generation
      // Focus on parent name field
      document.getElementById("parentName").focus();
    }
    
    // Rhetorical Balance Control Functions
    function updateRhetoricalBalance() {
      const ethos = parseInt(document.getElementById('ethosSlider').value);
      const pathos = parseInt(document.getElementById('pathosSlider').value);
      const logos = parseInt(document.getElementById('logosSlider').value);
      const general = parseInt(document.getElementById('generalSlider').value);
      
      const total = ethos + pathos + logos + general;
      
      // Update displays
      document.getElementById('ethosValue').textContent = ethos + '%';
      document.getElementById('pathosValue').textContent = pathos + '%';
      document.getElementById('logosValue').textContent = logos + '%';
      document.getElementById('generalValue').textContent = general + '%';
      document.getElementById('totalPercentage').textContent = total;
      
      // Update slider backgrounds
      document.getElementById('ethosSlider').style.background = `linear-gradient(to right, #3498db 0%, #3498db ${ethos}%, #e0e0e0 ${ethos}%, #e0e0e0 100%)`;
      document.getElementById('pathosSlider').style.background = `linear-gradient(to right, #e74c3c 0%, #e74c3c ${pathos}%, #e0e0e0 ${pathos}%, #e0e0e0 100%)`;
      document.getElementById('logosSlider').style.background = `linear-gradient(to right, #2ecc71 0%, #2ecc71 ${logos}%, #e0e0e0 ${logos}%, #e0e0e0 100%)`;
      document.getElementById('generalSlider').style.background = `linear-gradient(to right, #95a5a6 0%, #95a5a6 ${general}%, #e0e0e0 ${general}%, #e0e0e0 100%)`;
      
      // Update warning display
      const warningBox = document.getElementById('balanceWarning');
      if (total === 100) {
        warningBox.style.background = '#d4edda';
        warningBox.style.color = '#155724';
        warningBox.style.borderColor = '#c3e6cb';
        warningBox.innerHTML = `‚úÖ Total: <span id="totalPercentage">${total}</span>% (Perfect Balance)`;
      } else if (total < 100) {
        warningBox.style.background = '#fff3cd';
        warningBox.style.color = '#856404';
        warningBox.style.borderColor = '#ffc107';
        warningBox.innerHTML = `‚ö†Ô∏è Total: <span id="totalPercentage">${total}</span>% (Need ${100 - total}% more)`;
      } else {
        warningBox.style.background = '#f8d7da';
        warningBox.style.color = '#721c24';
        warningBox.style.borderColor = '#f5c6cb';
        warningBox.innerHTML = `‚ùå Total: <span id="totalPercentage">${total}</span>% (${total - 100}% over limit!)`;
      }
    }
    
    function setPreset(presetName) {
      let ethos = 25, pathos = 25, logos = 25, general = 25;
      
      switch(presetName) {
        case 'balanced':
          ethos = 25; pathos = 25; logos = 25; general = 25;
          break;
        case 'authoritative':
          ethos = 50; pathos = 10; logos = 30; general = 10;
          break;
        case 'compassionate':
          ethos = 15; pathos = 50; logos = 15; general = 20;
          break;
        case 'analytical':
          ethos = 20; pathos = 10; logos = 55; general = 15;
          break;
        case 'straightforward':
          ethos = 10; pathos = 10; logos = 15; general = 65;
          break;
      }
      
      document.getElementById('ethosSlider').value = ethos;
      document.getElementById('pathosSlider').value = pathos;
      document.getElementById('logosSlider').value = logos;
      document.getElementById('generalSlider').value = general;
      
      updateRhetoricalBalance();
    }
    
    // Advanced AI Email Generator with Rhetorical Balance
    function generateAIEmail() {
      const data = window.currentDetentionData;
      if (!data) return;
      
      const parentName = document.getElementById("parentName").value.trim();
      const detentionRoom = document.getElementById("detentionRoom").value.trim();
      const detentionTime = document.getElementById("detentionTime").value.trim();
      const additionalContext = document.getElementById("additionalContext").value.trim();
      
      // Validate required fields
      if (!parentName) {
        alert("Please enter the Parent/Guardian Name before generating the email.");
        document.getElementById("parentName").focus();
        return;
      }
      
      if (!detentionRoom) {
        alert("Please enter the Detention Room/Location before generating the email.");
        document.getElementById("detentionRoom").focus();
        return;
      }
      
      if (!detentionTime) {
        alert("Please enter the Detention Time before generating the email.");
        document.getElementById("detentionTime").focus();
        return;
      }
      
      // Get rhetorical balance
      const ethos = parseInt(document.getElementById('ethosSlider').value);
      const pathos = parseInt(document.getElementById('pathosSlider').value);
      const logos = parseInt(document.getElementById('logosSlider').value);
      const general = parseInt(document.getElementById('generalSlider').value);
      const total = ethos + pathos + logos + general;
      
      // Validate 100% total
      if (total !== 100) {
        alert(`Rhetorical balance must total exactly 100%. Current total: ${total}%\n\nPlease adjust the sliders before generating.`);
        return;
      }
      
      // Generate email with custom balance
      const message = generateBalancedEmail(data, parentName, detentionRoom, detentionTime, additionalContext, ethos, pathos, logos, general);
      
      document.getElementById("emailMessage").value = message;
      
      // Update analysis bars
      updateAnalysisBars(ethos, pathos, logos, general);
      
      // Show message section
      document.getElementById("messageSection").style.display = "block";
      
      // Scroll to message
      document.getElementById("emailMessage").scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function updateAnalysisBars(ethos, pathos, logos, general) {
      document.getElementById('messageEthosBar').style.width = ethos + '%';
      document.getElementById('messageEthosPercent').textContent = ethos + '%';
      
      document.getElementById('messagePathosBar').style.width = pathos + '%';
      document.getElementById('messagePathosPercent').textContent = pathos + '%';
      
      document.getElementById('messageLogosBar').style.width = logos + '%';
      document.getElementById('messageLogosPercent').textContent = logos + '%';
      
      document.getElementById('messageGeneralBar').style.width = general + '%';
      document.getElementById('messageGeneralPercent').textContent = general + '%';
    }
    
    // Generate Balanced Email with Custom Rhetorical Emphasis
    function generateBalancedEmail(data, parentName, room, time, context, ethosPercent, pathosPercent, logosPercent, generalPercent) {
      // Initialize email content
      let email = '';
      
      // Massive libraries of rhetorical elements categorized by type
      
      // ETHOS: Credibility, authority, professional expertise
      const ethosGreetings = [
        `Dear ${parentName}, as ${data.teacherName}, I'm writing to you in my professional capacity`,
        `${parentName}, this communication comes from ${data.teacherName}, a dedicated educator at Connecticut Technical Education and Career System`,
        `Good ${getTimeOfDay()}, ${parentName}. I'm ${data.teacherName}, reaching out as ${data.studentFirstName}'s teacher with important information`,
        `Hello ${parentName}. As an experienced educator here at our institution, I need to discuss a matter concerning ${data.studentName}`,
        `Dear ${parentName}, as part of my professional responsibility in overseeing ${data.studentFirstName}'s academic development`
      ];
      
      const ethosOpenings = [
        `In my ${getRandomNumber(5, 18)} years of educational experience, I've learned that addressing behavioral matters promptly and professionally benefits all stakeholders. Today I must inform you about ${data.studentName}.`,
        `As a certified educator with extensive training in adolescent development and classroom management, I'm reaching out regarding ${data.studentFirstName}. Our school maintains the highest standards of professionalism in all communications.`,
        `I hold advanced qualifications in ${pickRandom(['educational psychology', 'classroom management', 'student behavioral interventions', 'pedagogical best practices'])}, which informs my approach to this situation involving ${data.studentName}.`,
        `Our institution prides itself on evidence-based practices and professional conduct. In that spirit, I must discuss an incident involving ${data.studentFirstName} that occurred recently.`,
        `Professional ethics require me to maintain open, transparent communication with families. This message concerns ${data.studentName} and reflects our school's commitment to accountability.`,
        `As ${data.teacherName}, I've been entrusted with ${data.studentFirstName}'s education by this institution. That responsibility includes informing you about behavioral matters.`,
        `Connecticut Technical Education and Career System has established protocols for addressing student behavior. Following these professional guidelines, I'm contacting you about ${data.studentName}.`
      ];
      
      const ethosStatements = [
        `Our school's behavioral framework is grounded in decades of educational research and has been validated across ${getRandomNumber(500, 2000)} institutions nationwide.`,
        `I've completed ${getRandomNumber(40, 120)} hours of professional development in restorative discipline practices, ensuring my approach is both current and effective.`,
        `This institution employs best practices endorsed by the ${pickRandom(['American Federation of Teachers', 'National Association of Secondary School Principals', 'Association for Supervision and Curriculum Development'])}.`,
        `My ${pickRandom(['Master\'s degree', 'advanced certification', 'specialized training'])} in education specifically prepared me to handle situations like this with professionalism and expertise.`,
        `Studies from leading educational journals demonstrate that our approach to behavioral interventions yields ${getRandomNumber(75, 95)}% improvement rates in student conduct.`,
        `I'm licensed by the state as a professional educator, which comes with both privileges and responsibilities‚Äîincluding keeping parents informed with accurate, unbiased information.`,
        `Our administrative team reviews all disciplinary actions to ensure consistency, fairness, and adherence to established policies approved by the board of education.`,
        `Research published in the Journal of Educational Psychology supports the intervention model we're implementing with ${data.studentFirstName}.`,
        `This school has received ${pickRandom(['state recognition', 'accreditation', 'commendation'])} for our comprehensive approach to student development, both academic and behavioral.`
      ];
      
      // PATHOS: Emotion, empathy, connection, care
      const pathosGreetings = [
        `Dear ${parentName}, I hope this message finds you and your family well`,
        `Hello ${parentName}‚ÄîI want to start by saying that I care deeply about ${data.studentFirstName}`,
        `Dear ${parentName}, first, let me express my genuine concern for ${data.studentName}'s wellbeing and success`,
        `${parentName}, I'm writing with both professionalism and heartfelt care about your ${pickRandom(['child', 'son/daughter', 'student'])}`,
        `Good ${getTimeOfDay()}, ${parentName}. Before I share details, know that ${data.studentFirstName} matters to me`
      ];
      
      const pathosOpenings = [
        `${data.studentFirstName} is more than just a student to me‚Äîthey're a young person with enormous potential, and I'm invested in helping them thrive. That's why this message is important.`,
        `Every day, I walk into my classroom thinking about how I can make a difference in students' lives. ${data.studentName} is one of those students I care about deeply, which makes this conversation necessary.`,
        `As someone who's dedicated their career to supporting young people, I never take situations like this lightly. ${data.studentFirstName} deserves our combined attention and support right now.`,
        `I believe in ${data.studentName}. I believe in their capacity to learn, grow, and make better choices. That belief drives me to reach out to you today about a concerning incident.`,
        `My heart goes out to families when I have to share difficult news. Please know this communication comes from a place of genuine care for ${data.studentFirstName}'s future.`,
        `${data.studentFirstName} has so much to offer the world. I see glimmers of their potential regularly, which is why addressing this behavioral concern is so important to me personally.`,
        `One of the hardest parts of teaching is balancing accountability with compassion. I'm trying to do both here as I discuss ${data.studentName} with you.`
      ];
      
      const pathosStatements = [
        `I want ${data.studentFirstName} to know that making a mistake doesn't diminish their worth as a person. We all stumble; what matters is how we respond and grow.`,
        `${data.studentName} brings ${pickRandom(['unique energy', 'special qualities', 'important perspectives', 'valuable contributions'])} to our classroom community. This incident doesn't change my belief in who they can become.`,
        `Imagine ${data.studentFirstName} five years from now‚Äîconfident, responsible, thriving. That's the future I'm working toward with this intervention.`,
        `As ${pickRandom(['a parent myself', 'an educator who deeply cares', 'someone invested in student success'])}, I understand how concerning it is to receive a message like this. My intention is to help, never to harm.`,
        `${data.studentFirstName} is at a crucial developmental stage. The guidance we provide now‚Äîwith love and firmness‚Äîwill shape the adult they become.`,
        `I've seen students overcome far greater challenges than this. ${data.studentName} absolutely has what it takes to learn from this experience and emerge stronger.`,
        `Young people need to know they're valued even when they make poor choices. I want ${data.studentFirstName} to feel supported while also understanding the importance of accountability.`,
        `The relationship between home and school is sacred. When we work together with shared love for ${data.studentName}, incredible growth becomes possible.`,
        `I lie awake sometimes thinking about my students' futures. ${data.studentFirstName} is one of those students whose success I genuinely care about achieving.`
      ];
      
      // LOGOS: Logic, data, reasoning, cause-and-effect
      const logosGreetings = [
        `Dear ${parentName}, I'm writing to present factual information regarding ${data.studentName}`,
        `Hello ${parentName}. This communication outlines the details of an incident involving ${data.studentFirstName} that requires documentation and follow-up`,
        `${parentName}, the following message contains objective information about a behavioral matter concerning ${data.studentName}`,
        `Good ${getTimeOfDay()}, ${parentName}. Below you'll find a comprehensive account of events involving ${data.studentFirstName}`,
        `Dear ${parentName}, logic and clarity guide this communication about ${data.studentName}`
      ];
      
      const logosOpenings = [
        `On ${data.incidentDate}, a documented behavioral incident occurred involving ${data.studentName}. The following information outlines the facts of the situation.`,
        `Data from ${data.incidentDate} indicates that ${data.studentFirstName} engaged in conduct that violates established school policies. Here are the specifics.`,
        `Behavioral research demonstrates that timely communication between school and home correlates with ${getRandomNumber(60, 85)}% improvement in student conduct. Following that evidence, I'm contacting you about ${data.studentName}.`,
        `According to our records and documented observations, ${data.studentFirstName} was involved in an incident on ${data.incidentDate}. The details are as follows.`,
        `Studies show that clear, factual communication prevents misunderstandings. In that spirit, here are the objective facts about ${data.studentName}'s recent behavior.`,
        `The incident involving ${data.studentFirstName} has been documented in accordance with school policy. This message provides you with the pertinent details for your records.`,
        `Logical analysis of the situation involving ${data.studentName} yields the following understanding of events and appropriate consequences.`
      ];
      
      const logosStatements = [
        `Research indicates that students who receive immediate behavioral feedback show ${getRandomNumber(55, 78)}% reduction in repeat offenses within the same academic year.`,
        `According to a ${getRandomNumber(3, 8)}-year longitudinal study published by ${pickRandom(['Stanford University', 'the National Education Policy Center', 'Harvard\'s Graduate School of Education'])}, early interventions prevent escalation in ${getRandomNumber(70, 92)}% of cases.`,
        `The causal relationship is clear: when behavioral expectations are enforced consistently, student outcomes improve across ${getRandomNumber(6, 12)} measurable metrics.`,
        `Data from our school shows that ${getRandomNumber(82, 96)}% of students who complete detention successfully avoid further disciplinary action that semester.`,
        `Statistical analysis demonstrates that parental involvement in addressing school behavior issues increases positive outcomes by ${getRandomNumber(45, 73)}%.`,
        `Evidence-based practices indicate that detention paired with reflection yields better long-term results than ${pickRandom(['suspension', 'in-school isolation', 'punitive measures alone'])}.`,
        `The logical progression is: behavior occurs ‚Üí consequence applied ‚Üí reflection happens ‚Üí future choices improve. This sequence has proven effective across thousands of implementations.`,
        `If we consider the variables‚Äîpeer influence, environmental factors, developmental stage‚Äîthe appropriate intervention becomes clear: structured reflection time, which detention provides.`,
        `Cost-benefit analysis supports this approach: a brief detention now prevents potentially serious consequences later, protecting ${data.studentFirstName}'s academic trajectory.`,
        `Empirical evidence from ${getRandomNumber(400, 900)} schools using similar behavioral frameworks shows measurable improvement in school culture and individual student performance.`
      ];
      
      // GENERAL: Neutral, straightforward, professional without rhetorical emphasis
      const generalGreetings = [
        `Dear ${parentName},`,
        `Hello ${parentName},`,
        `${parentName},`,
        `Good ${getTimeOfDay()}, ${parentName},`,
        `To ${parentName},`
      ];
      
      const generalOpenings = [
        `I'm writing to inform you about ${data.studentName}. This message concerns an incident that occurred at school.`,
        `This communication is regarding ${data.studentFirstName}. An event took place that requires your attention.`,
        `${data.studentName} was involved in a behavioral incident. The details are provided below.`,
        `I need to discuss ${data.studentFirstName} with you. A situation arose that needs to be addressed.`,
        `This message concerns ${data.studentName}. Please review the information that follows.`,
        `${data.studentFirstName} was documented for a behavioral matter. Here is what happened.`,
        `I'm contacting you about ${data.studentName}. This email outlines an incident and the response.`
      ];
      
      const generalStatements = [
        `The incident occurred on ${data.incidentDate} during ${data.period ? `Period ${data.period}` : 'school hours'} at ${data.location}.`,
        `${data.studentFirstName} was assigned detention as a consequence. The detention is scheduled for ${time} in ${room}.`,
        `The behavior was categorized as "${data.mainType}" with specific classification of "${data.subType}."`,
        `School policy requires notification when students receive detention. This message fulfills that requirement.`,
        `${data.studentName} must attend the detention at the scheduled time. Failure to attend may result in additional consequences.`,
        `The relevant details are: incident date ${data.incidentDate}, location ${data.location}, behavior type ${data.mainType}.`,
        `This information is being provided for your records and to ensure ${data.studentFirstName} attends the assigned detention.`,
        `Please contact the school if you have questions or need additional information about this matter.`,
        `${data.studentFirstName}'s attendance at detention is mandatory. Please ensure they understand this expectation.`
      ];
      
      // Build email by allocating content proportionally to rhetorical percentages
      
      // Greeting (use highest percentage category or random mix)
      let greeting = '';
      const greetingCategories = [
        { cat: 'ethos', pct: ethosPercent, greetings: ethosGreetings },
        { cat: 'pathos', pct: pathosPercent, greetings: pathosGreetings },
        { cat: 'logos', pct: logosPercent, greetings: logosGreetings },
        { cat: 'general', pct: generalPercent, greetings: generalGreetings }
      ];
      const dominantGreeting = greetingCategories.sort((a, b) => b.pct - a.pct)[0];
      greeting = pickRandom(dominantGreeting.greetings);
      
      email += `${greeting}\n\n`;
      
      // Opening (use highest percentage or blend)
      const openingCategories = [
        { cat: 'ethos', pct: ethosPercent, openings: ethosOpenings },
        { cat: 'pathos', pct: pathosPercent, openings: pathosOpenings },
        { cat: 'logos', pct: logosPercent, openings: logosOpenings },
        { cat: 'general', pct: generalPercent, openings: generalOpenings }
      ];
      const dominantOpening = openingCategories.sort((a, b) => b.pct - a.pct)[0];
      email += `${pickRandom(dominantOpening.openings)}\n\n`;
      
      // Core incident details (always present, mostly Logos/General)
      email += `**Incident Details:**\n`;
      email += `On ${data.incidentDate}, ${data.studentFirstName} was documented for behavior classified as "${data.mainType}" (specifically: "${data.subType}"). This occurred during ${data.period ? `Period ${data.period}` : 'school hours'} at ${data.location}.\n\n`;
      
      if (context) {
        email += `**Additional Context Provided by Teacher:**\n${context}\n\n`;
      }
      
      // Body paragraphs - allocate based on percentages
      const totalBodyStatements = 8;
      const ethosCount = Math.round((ethosPercent / 100) * totalBodyStatements);
      const pathosCount = Math.round((pathosPercent / 100) * totalBodyStatements);
      const logosCount = Math.round((logosPercent / 100) * totalBodyStatements);
      const generalCount = totalBodyStatements - ethosCount - pathosCount - logosCount;
      
      let statements = [];
      
      // Add Ethos statements
      for (let i = 0; i < ethosCount; i++) {
        statements.push({ type: 'ethos', text: pickRandomUnique(ethosStatements, statements) });
      }
      
      // Add Pathos statements
      for (let i = 0; i < pathosCount; i++) {
        statements.push({ type: 'pathos', text: pickRandomUnique(pathosStatements, statements) });
      }
      
      // Add Logos statements
      for (let i = 0; i < logosCount; i++) {
        statements.push({ type: 'logos', text: pickRandomUnique(logosStatements, statements) });
      }
      
      // Add General statements
      for (let i = 0; i < generalCount; i++) {
        statements.push({ type: 'general', text: pickRandomUnique(generalStatements, statements) });
      }
      
      // Shuffle statements for natural flow
      statements = shuffleArray(statements);
      
      // Group into paragraphs
      let currentParagraph = '';
      let sentenceCount = 0;
      statements.forEach((stmt, index) => {
        currentParagraph += stmt.text + ' ';
        sentenceCount++;
        
        // Create paragraph break every 2-3 statements
        if (sentenceCount >= getRandomNumber(2, 3) || index === statements.length - 1) {
          email += currentParagraph.trim() + '\n\n';
          currentParagraph = '';
          sentenceCount = 0;
        }
      });
      
      // Detention specifics
      email += `**Detention Assignment:**\n`;
      email += `‚Ä¢ Date: ${data.incidentDate}\n`;
      email += `‚Ä¢ Time: ${time}\n`;
      email += `‚Ä¢ Location: ${room}\n`;
      email += `‚Ä¢ Student: ${data.studentName}${data.grade ? `, ${data.grade}` : ''}\n`;
      email += `‚Ä¢ Assigned by: ${data.teacherName}\n\n`;
      
      // Closing based on dominant rhetoric
      const closings = {
        ethos: [
          `In my professional judgment, this intervention will serve ${data.studentFirstName} well. Please don't hesitate to contact me if you need further information.`,
          `As an experienced educator, I'm confident this approach will yield positive results. I'm available for consultation should you wish to discuss further.`,
          `Professional standards require me to be available for follow-up communication. Please reach out if needed.`
        ],
        pathos: [
          `I genuinely believe ${data.studentFirstName} will learn from this and emerge stronger. Together, we can support their growth.`,
          `${data.studentName} has tremendous potential. With your support at home and mine at school, this will be a valuable learning experience.`,
          `I care about ${data.studentFirstName}'s success and am here to help. Please know I'm always available if you'd like to talk.`
        ],
        logos: [
          `Data supports the effectiveness of this intervention. Attendance at detention is mandatory and expected.`,
          `Research indicates this approach produces optimal outcomes. Please ensure ${data.studentFirstName} complies with the detention requirement.`,
          `Based on evidence and established protocols, this is the appropriate response. Contact me if you have questions.`
        ],
        general: [
          `Please contact me if you have questions or concerns about this matter.`,
          `Let me know if you need additional information. Thank you for your attention to this.`,
          `I'm available if you'd like to discuss this further. Thank you.`
        ]
      };
      
      const dominantRhetoric = [
        { type: 'ethos', pct: ethosPercent },
        { type: 'pathos', pct: pathosPercent },
        { type: 'logos', pct: logosPercent },
        { type: 'general', pct: generalPercent }
      ].sort((a, b) => b.pct - a.pct)[0].type;
      
      email += pickRandom(closings[dominantRhetoric]) + '\n\n';
      
      // Sign-off
      const signOffs = ['Sincerely,', 'Best regards,', 'Respectfully,', 'Thank you,', 'Warm regards,', 'Professionally yours,', 'Kind regards,'];
      email += `${pickRandom(signOffs)}\n\n`;
      email += `${data.teacherName}\n`;
      if (data.teacherEmail) email += `${data.teacherEmail}\n`;
      email += `Connecticut Technical Education and Career System`;
      
      return email;
    }
    
    // Helper: Pick random unique (avoid duplicates in same email)
    function pickRandomUnique(arr, usedStatements) {
      const usedTexts = usedStatements.map(s => s.text);
      const available = arr.filter(item => !usedTexts.includes(item));
      if (available.length === 0) return pickRandom(arr); // Fallback if all used
      return pickRandom(available);
    }
    
    // Helper: Shuffle array
    function shuffleArray(arr) {
      const shuffled = [...arr];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }
    
    // Helper: Pick random from array
    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
    
    // Helper: Random number
    function getRandomNumber(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Helper: Time of day
    function getTimeOfDay() {
      const hour = new Date().getHours();
      if (hour < 12) return "morning";
      if (hour < 17) return "afternoon";
      return "evening";
    }
    
    // Helper: Day description
    function getDayDescription() {
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
      const descriptors = ["productive", "successful", "positive", "great", "wonderful"];
      return Math.random() > 0.5 ? pickRandom(days) : pickRandom(descriptors) + " day";
    }
    
    // Generate random rhetorical statements
    function generateRandomRhetoric(data) {
      const ethosStatements = [
        `As an educator with ${getRandomNumber(5, 20)} years of experience, I've learned that addressing behavioral issues early and constructively prevents larger problems down the road.`,
        `Our school's approach is grounded in educational research and best practices that have been proven effective across thousands of schools nationwide.`,
        `I hold a ${pickRandom(['Master\'s degree in Education', 'certification in classroom management', 'background in adolescent psychology'])}, and I use that knowledge to approach discipline as an opportunity for growth, not punishment.`,
        `This school has a ${getRandomNumber(85, 98)}% success rate in helping students who receive early interventions turn their behavior around and finish the year strong.`
      ];
      
      const pathosStatements = [
        `I care deeply about every student in my classroom, including ${data.studentFirstName}. That's why I'm taking the time to reach out‚Äîbecause ${data.studentFirstName} matters.`,
        `Imagine the kind of adult ${data.studentFirstName} can become with the right guidance now. That's what motivates me to address situations like this with care and intention.`,
        `${data.studentFirstName} has so much potential. I've seen glimpses of their capabilities, and I don't want poor choices to derail their future opportunities.`,
        `As a parent myself, I understand how concerning it can be to receive a message like this. Please know that my intention is to help, not to judge or criticize.`
      ];
      
      const logosStatements = [
        `Studies show that students who receive timely behavioral interventions are ${getRandomNumber(60, 85)}% less likely to repeat the same behaviors in the future.`,
        `According to research from the ${pickRandom(['American Educational Research Association', 'National Education Association', 'Journal of Educational Psychology'])}, consistent consequences paired with reflection time lead to lasting behavioral change.`,
        `The data is clear: when parents are involved in addressing school behavior issues, positive outcomes increase by ${getRandomNumber(40, 70)}%.`,
        `Evidence-based practices tell us that detention paired with restorative conversations produces better long-term results than suspension or other punitive measures.`
      ];
      
      const combined = [...ethosStatements, ...pathosStatements, ...logosStatements];
      return pickRandom(combined);
    }
    
    function updateEmailMessage() {
      // This function is now deprecated - generation is manual only
    }

    function closeEmailModal() {
      const modal = document.getElementById("emailModal");
      modal.style.display = "none";
      
      // Reset form
      document.getElementById("emailForm").reset();
    }

    function sendEmail() {
      const emailToStudent = document.getElementById("emailToStudent").value.trim();
      const emailToParent = document.getElementById("emailToParent").value.trim();
      const emailSubject = document.getElementById("emailSubject").value.trim();
      const emailMessage = document.getElementById("emailMessage").value.trim();
      const parentName = document.getElementById("parentName").value.trim();
      const detentionRoom = document.getElementById("detentionRoom").value.trim();
      const detentionTime = document.getElementById("detentionTime").value.trim();
      
      // Check if message has been generated
      if (!emailMessage || emailMessage.length < 50) {
        alert("Please generate an email message using the 'Generate AI Email' button before sending.");
        return;
      }
      
      // Check if required teacher fields are filled
      if (!parentName) {
        alert("Please enter the Parent/Guardian Name before sending.");
        document.getElementById("parentName").focus();
        return;
      }
      
      if (!detentionRoom) {
        alert("Please enter the Detention Room/Location before sending.");
        document.getElementById("detentionRoom").focus();
        return;
      }
      
      if (!detentionTime) {
        alert("Please enter the Detention Time before sending.");
        document.getElementById("detentionTime").focus();
        return;
      }
      
      // Validation for email addresses
      if (!emailToStudent) {
        alert("Please enter the student's email address.");
        document.getElementById("emailToStudent").focus();
        return;
      }
      
      if (!isValidEmail(emailToStudent)) {
        alert("Please enter a valid student email address.");
        document.getElementById("emailToStudent").focus();
        return;
      }
      
      if (!emailToParent) {
        alert("Please enter the parent/guardian's email address.");
        document.getElementById("emailToParent").focus();
        return;
      }
      
      if (!isValidEmail(emailToParent)) {
        alert("Please enter a valid parent/guardian email address.");
        document.getElementById("emailToParent").focus();
        return;
      }
      
      if (!emailSubject) {
        alert("Please enter a subject.");
        document.getElementById("emailSubject").focus();
        return;
      }
      
      // Build mailto URL with both recipients and CC
      let mailtoUrl = `mailto:${encodeURIComponent(emailToStudent)},${encodeURIComponent(emailToParent)}`;
      mailtoUrl += `?cc=${encodeURIComponent('kristina.knapp@cttech.org')}`;
      mailtoUrl += `&subject=${encodeURIComponent(emailSubject)}`;
      
      if (emailMessage) {
        mailtoUrl += `&body=${encodeURIComponent(emailMessage)}`;
      }
      
      // Open email client
      try {
        window.location.href = mailtoUrl;
        closeEmailModal();
        
        // Show success message
        setTimeout(() => {
          alert("Email client opened successfully! Your professionally crafted AI-generated notification will be sent to both the student and parent/guardian with CC to administration.");
        }, 500);
        
      } catch (error) {
        console.error("Error opening email client:", error);
        alert("Error opening email client. Please copy the information manually or try a different email method.");
      }
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
      const modal = document.getElementById("emailModal");
      if (event.target === modal) {
        closeEmailModal();
      }
    });

    // Handle escape key to close modal
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById("emailModal");
        if (modal.style.display === "block") {
          closeEmailModal();
        }
      }
    });
  </script>
</div> <!-- End main-content -->
<footer style="text-align: center; padding: 20px; color: white; font-size: 14px; background: rgba(0,0,0,0.2);">
  Created by Riley Joseph Santor
</footer>
</body>
</html>
